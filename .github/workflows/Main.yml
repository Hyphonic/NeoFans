name: Download Posts

on:
  workflow_dispatch:

#concurrency:
#  group: download-posts

jobs:
  download-content:
    name: ğŸŒ Download Content
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ—‘ï¸ Cleanup Workflow Runs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          # Find and delete failed workflow runs
          gh run list --limit 100 --repo "$REPO" --json databaseId,conclusion | jq -c '.[] | select(.conclusion == "failure" or .conclusion == "cancelled") | .databaseId' | while read -r run_id; do
            echo "Deleting failed workflow with ID $run_id"
            gh run delete "$run_id" --repo "$REPO"
          done

      - name: ğŸ“œ Pyscan 
        uses: aswinnnn/pyscan-check@v1.0.0
        with:
          upload-artifact: true

      # - name: ğŸ’¾ Free Disk Space
      #   uses: jlumbroso/free-disk-space@main
      #   with:
      #     tool-cache: true

      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Set Up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'
      
      - name: ğŸ“¦ Install Dependencies
        run: pip install -r requirements.txt

      # - name: ğŸ”§ Install Rclone
      #   uses: AnimMouse/setup-rclone@v1
      #   with:
      #     rclone_config: ${{ secrets.PIXELDRAIN_CONF }}
      #     disable_base64: true

      - name: â¬ Download All Content
        env:
          COLUMNS: 120
          E621_LOGIN: ${{ secrets.E621_LOGIN }}
          E621_API_KEY: ${{ secrets.E621_API_KEY }}
          KEMONO_SESS: ${{ secrets.KEMONO_SESS }}
          COOMER_SESS: ${{ secrets.COOMER_SESS }}
        run: |
          python Main.py
      
      - name: ğŸ“ƒ List Files
        run: |
          ls -lh
          tree -L 2 -CF
          cat cached_hashes.json

      - name: ğŸ”¼ Commit updated hashes
        if: success()
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git pull
          git add cached_hashes.json
          git commit -m "Update cached hashes"
          git push

      # - name: ğŸ” Trigger Next Workflow
      #   if: success()
      #   run: |
      #     gh workflow run "Download Posts" --ref main
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # - name: ğŸŒ Upload Data with Rclone
      #   run: |
      #     echo "ğŸŸ¢ Uploading Data to Pixeldrain..."
      #     rclone copy . Pixeldrain: --disable-http2 --multi-thread-streams 2 --transfers 32 -v
      #     echo "ğŸŸ¢ Upload complete."
