name: Download Posts

on:
  workflow_dispatch:

concurrency:
  group: download-posts
  cancel-in-progress: false

jobs:
  download-content:
    strategy:
      fail-fast: false
    name: ğŸŒ Download Content
    runs-on: ubuntu-latest
    steps:
      #- name: ğŸ’¾ Free Disk Space
      #  uses: jlumbroso/free-disk-space@main
      #  with:
      #    tool-cache: true

      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: â™»ï¸ Set Up Warp
        run: |
          curl -fsSL https://pkg.cloudflareclient.com/pubkey.gpg | sudo gpg --yes --dearmor --output /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com/ $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/cloudflare-client.list
          sudo apt-get update && sudo apt-get install cloudflare-warp
          sudo warp-cli --accept-tos registration new
          sudo warp-cli --accept-tos mode warp+doh
          sudo warp-cli --accept-tos connect
          curl https://www.cloudflare.com/cdn-cgi/trace/

      - name: ğŸ“¦ Set Up Python
        uses: actions/setup-python@v5.4.0
        with:
          python-version: '3.13'
      
      - name: ğŸ“¦ Install Dependencies
        run: pip install -r requirements.txt

      - name: ğŸ”§ Install Rclone
        uses: AnimMouse/setup-rclone@v1
        with:
          rclone_config: ${{ secrets.PIXELDRAIN_CONF }}
          disable_base64: true

      - name: â¬ Download All Content
        env:
          COLUMNS: 120
          E621_LOGIN: ${{ secrets.E621_LOGIN }}
          E621_API_KEY: ${{ secrets.E621_API_KEY }}
          KEMONO_SESS: ${{ secrets.KEMONO_SESS }}
          COOMER_SESS: ${{ secrets.COOMER_SESS }}
        run: |
          python Fetcher.py
      
      - name: ğŸ“ƒ List Files
        run: |
          cat Data/LPD.json

      - name: ğŸ”¼ Commit LPD
        if: success()
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git pull
          git add Data/*.json
          git commit -m "Update Data"
          git push

      - name: ğŸŒ Upload Data with Rclone
        run: |
          echo "ğŸŸ¢ Reading optimal transfer count..."
          TRANSFERS=$(cat Data/Transfers.txt)
          echo "ğŸŸ¢ Using ${TRANSFERS} transfer threads"
          echo "ğŸŸ¢ Uploading Data to Pixeldrain..."
          rclone copy Data/Files Pixeldrain: --disable-http2 --multi-thread-streams 3 --transfers ${TRANSFERS} -v
          echo "ğŸŸ¢ Upload complete."
      
      # - name: ğŸ” Trigger Next Workflow
      #   if: success()
      #   run: |
      #     gh workflow run "Download Posts" --ref main
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
