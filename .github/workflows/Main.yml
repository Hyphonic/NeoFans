name: Download Posts

on:
  workflow_dispatch:

#concurrency:
#  group: download-posts

jobs:
  download-content:
    name: ğŸŒ Download Content
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ’¾ Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true

      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Set Up Python
        uses: actions/setup-python@v5.4.0
        with:
          python-version: '3.13'
      
      - name: ğŸ“¦ Install Dependencies
        run: pip install -r requirements.txt

      - name: ğŸ”§ Install Rclone
        uses: AnimMouse/setup-rclone@v1
        with:
          rclone_config: ${{ secrets.PIXELDRAIN_CONF }}
          disable_base64: true

      - name: â¬ Download All Content
        env:
          COLUMNS: 120
          E621_LOGIN: ${{ secrets.E621_LOGIN }}
          E621_API_KEY: ${{ secrets.E621_API_KEY }}
          KEMONO_SESS: ${{ secrets.KEMONO_SESS }}
          COOMER_SESS: ${{ secrets.COOMER_SESS }}
        run: |
          python Fetcher.py
      
      - name: ğŸ“ƒ List Files
        run: |
          cat Data/*.json
          tree

      - name: ğŸ”¼ Commit updated hashes
        if: success()
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git pull
          git add Data/*.json
          git commit -m "Update Cached Hashes"
          git push

      - name: ğŸ” Trigger Next Workflow
        if: success()
        run: |
          gh workflow run "Download Posts" --ref main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸŒ Upload Data with Rclone
        run: |
          echo "ğŸŸ¢ Uploading Data to Pixeldrain..."
          rclone copy Data/Files Pixeldrain: --disable-http2 --multi-thread-streams 2 --transfers 32 -v
          echo "ğŸŸ¢ Upload complete."
